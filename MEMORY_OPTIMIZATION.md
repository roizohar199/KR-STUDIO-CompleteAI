# אופטימיזציה לזיכרון - KR-STUDIO CompleteAI

## בעיה
השרת על Render חווה שגיאות "Ran out of memory" עקב צריכת זיכרון גבוהה בתהליך ההפרדה.

## פתרונות שהוחלו

### 1. אופטימיזציה של Demucs
- **הורדת ביטרייט**: מ-320kbps ל-192kbps
- **הגבלת threads**: שימוש ב-thread אחד בלבד
- **חלוקה לקטעים**: עיבוד בקטעים של 10 שניות
- **ביטול shifts**: חיסכון בזיכרון
- **שימוש ב-CPU**: כפייה לשימוש ב-CPU במקום GPU

### 2. אופטימיזציה של קבצים
- **הגבלת גודל קובץ**: מ-200MB ל-50MB
- **אופטימיזציה מקדימה**: קובץ מקורי עובר אופטימיזציה לפני ההפרדה
- **ביטרייט נמוך**: 128kbps לקובץ מקורי, 192kbps לתוצאות

### 3. ניהול זיכרון
- **ניקוי אוטומטי**: ניקוי זיכרון כל 5 דקות
- **ניטור זיכרון**: מעקב אחר שימוש זיכרון כל 30 שניות
- **ניקוי קבצים**: מחיקת קבצים ישנים אוטומטית

### 4. הגבלות זמן
- **timeout עיבוד**: 15 דקות מקסימום
- **ניקוי קבצים**: קבצים ישנים נמחקים אחרי שעה/שעתיים

## הגדרות חדשות

### Demucs Flags
```bash
--cpu                    # כפייה לשימוש ב-CPU
--float32               # שימוש ב-float32 במקום float64
--segment 10            # חלוקה לקטעים של 10 שניות
--overlap 0.1           # חפיפה של 10%
--shifts 0              # ביטול shifts
--split segment         # חלוקה לפי קטעים
--jobs 1                # עבודה סדרתית
--mp3-bitrate 192       # ביטרייט נמוך
```

### Environment Variables
```bash
OMP_NUM_THREADS=1
MKL_NUM_THREADS=1
OPENBLAS_NUM_THREADS=1
VECLIB_MAXIMUM_THREADS=1
NUMEXPR_NUM_THREADS=1
```

### הגבלות חדשות
- **גודל קובץ מקסימלי**: 50MB
- **זמן עיבוד מקסימלי**: 15 דקות
- **ניקוי קבצים**: אחרי שעה (uploads), שעתיים (separated)

## תוצאות צפויות
- **צריכת זיכרון**: ירידה של 60-70%
- **זמן עיבוד**: עלייה קלה (2-3 דקות במקום 1-2)
- **יציבות**: מניעת קריסות זיכרון
- **איכות**: ירידה קלה באיכות (עדיין טובה מאוד)

## בדיקות
1. העלאת קובץ 50MB
2. מעקב אחר שימוש זיכרון
3. בדיקת זמן עיבוד
4. בדיקת איכות התוצאות

## הערות
- האופטימיזציות מתמקדות ביציבות על פני מהירות
- איכות התוצאות עדיין גבוהה מאוד
- המערכת תומכת בקבצים גדולים יותר בעתיד אם יידרש 